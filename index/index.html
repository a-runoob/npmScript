<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport" />
		<title>公会管理</title>
		<link rel="stylesheet" type="text/css" href="css/index.css" />
		<script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
		<script src="js/zxf_page.js"></script>
	</head>

	<body>
		<div id="main_home">
			<div class="search_header">
				<div class="search_inp_box">
					<input class="search_inp" type="text" id="search" oninput="if($(this).val() != ''){$('.close').show();}else{$('.close').hide();}" placeholder="输入资源名称进行搜索" />
					<span class="close" style="display: none;" onclick="$('#search').val('');$('.close').hide();"></span>
				</div>
				<button class="search_btn" onclick="$.configs.search()">搜索</button>
			</div>
			<div class="content_list">
				<div class="tab_header">
					<div class="tab_header_item active" data-type="0">全部</div>
				</div>
				<div class="tab_content"></div>
			</div>
		</div>
	</body>
	<script>
		//config配置参数   自定义对象   jq的对象
		$.configs = {
			search_text: '',
			//分页
			XHRdata: function(page, tab) {
				$.ajax({
					type: "get",
					url: "http://api.movie.iesuper.com/v1/movie/list",
					data: {
						page: page,
						tab: tab,
						q: $.configs.search_text
					},
					async: true,
					success: function(data) {
						console.log(data);
						$(".zxf_pagediv" + tab + "").createPage({
							pageNum: data.page_total,
							current: data.page
						});
						let cache = '';
						for(let i = 0; i < data.list.length; i++) {
							let htmls = '<li>' +
								'<div class="img_box">' +
								'<img class="video_img" src="' + data.list[i].img + '"/>' +
								'</div>' +
								'<div class="text_box">' +
								'<h4 class=" title nw2">' + data.list[i].name + '</h4>' +
								'<p class="time">片长: ' + data.list[i].duration + '</p>' +
								'<a class="dow_btn" href="' + data.list[i].durl + '" onclick="koalaDownload.open">极速下载</a>' +
								'</div>' +
								'</li>';
							cache += htmls;

						}
						$(".tab_content").find('.tab_inner').each(function(i) {
							console.log($(".tab_content").find('.tab_inner').eq(i).find('ul'));
							if(i == tab) {
								$(".tab_content").find('.tab_inner').eq(i).find('ul').html(cache);
							}
						})
					}
				});
			},
			getData: function(page, flag) {
				if(flag) {
					$.configs.XHRdata(page, 1);
				} else {
					$(".tab_header").find('.tab_header_item').each(function() {
						if($(this).attr('class').indexOf('active') != -1) {
							let tab = $(this).attr('data-type');
							$.configs.XHRdata(page, tab);
						}
					})
				}
			},
			search: function() {
				$.configs.search_text = $("#search").val();
				$(".tab_header_item").removeClass('active');
				$(".tab_header_item").eq(0).addClass('active');
				$(".tab_content").css({
					'transform': 'translateX(0vw)'
				});
				$.configs.getData(1, true);
				$('.list_scroll').eq(0).animate({
					"scrollTop": 0
				});
			},
			initType: function() {
				return new Promise((resolve, reject) => {
					$.ajax({
						type: "get",
						url: "http://api.movie.iesuper.com/v1/movie/category",
						async: true,
						success: function(data) {
							console.log(data);
							let cache = '';
							for(let i = 0; i < data.list.length; i++) {
								let typetag = '<div class="tab_header_item" data-type="' + data.list[i].id + '">' + data.list[i].name + '</div>';
								cache += typetag;
								let tabinner = '<div class="tab_inner" style="left:' + i * 100 + 'vw">' +
									'<div class="list_scroll">' +
									'<ul></ul>' +
									'<div class="zxf zxf_pagediv' + i + '"></div>' +
									'</div>' +
									'</div>';
								$('.tab_content').append(tabinner);
								$(".zxf_pagediv" + i + "").createPage({
									pageNum: 10,
									current: 1,
									backfun: function(e) {
										console.log(e); //回调
										$.configs.getData(e.current);
										$('.list_scroll').eq(i).animate({
											"scrollTop": 0
										});
									}
								});
							}
							let tabinner_last = '<div class="tab_inner" style="left:' + data.list.length * 100 + 'vw">' +
								'<div class="list_scroll">' +
								'<ul></ul>' +
								'<div class="zxf zxf_pagediv' + data.list.length + 1 + '"></div>' +
								'</div>' +
								'</div>';
							$('.tab_content').append(tabinner_last);
							$('.tab_content').css({
								"width": "" + (data.list.length + 2) * 100 + "vw"
							});
							$(".tab_header").append(cache);
							resolve(data);
						},
						error: function(e) {
							reject(e)
						}
					});
				})
			}
		}

		//初始化获取初次数据
		$.configs.initType().then((data) => {
			$.configs.getData();
		})

		//tab切换
		$(".tab_header").on('click', '.tab_header_item', function() {
			$(".tab_header_item").removeClass('active');
			$(this).addClass('active');
			console.log($(this).attr('data-type'));
			if($(this).attr('data-type') != 0) {
				$.configs.search_text = '';
			}
			$.configs.getData();
			$(".tab_content").css({
				'transform': 'translateX(' + $(this).attr('data-type') * -100 + 'vw)'
			})
		})

		//自动热跟新
		document.write('<script src="http://' + (location.host || 'localhost').split(':')[0] +
			':35729/livereload.js?snipver=1"></' + 'script>');
	</script>

</html>